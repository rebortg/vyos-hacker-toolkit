#!/usr/bin/env python3

import os
import sys
import argparse

sys.path.append(os.path.join(os.path.dirname(os.path.realpath(__file__)),"..", "lib"))

from vyostest import log
from vyostest import cmd
from vyostest import config
from vyostest import repository


HOME = '/home/vyos'
LOCATION = 'packages'

if __name__ == '__main__':
	parser = argparse.ArgumentParser(description='build and install a vyos debian package')
	parser.add_argument('-1', '--vyos', type=str, help='vyos-1x folder to build')
	parser.add_argument('-k', '--smoke', type=str, help="vyos-smoke folder to build")
	parser.add_argument('-c', '--cfg', type=str, help="vyatta-cfg-system folder to build")
	parser.add_argument('-o', '--op', type=str, help="vyatta-op folder to build")

	parser.add_argument('-e', '--extra', type=str, help='extra debian package(s) to install')
	parser.add_argument('-n', '--name', type=str, help='name/tag to add to the build version')
	parser.add_argument('-b', '--backdoor', type=str, help='install an admin account on the iso with this passord')
	parser.add_argument('-f', '--force', help="make without custom package", action='store_true')
	parser.add_argument('-t', '--test', help='test the iso when built', action='store_true')

	parser.add_argument('-7', '--setup', help='setup for use by this program', action='store_true')
	parser.add_argument('-s', '--show', help='only show what will be done', action='store_true')
	parser.add_argument('-v', '--verbose', help='show what is happening', action='store_true')
	parser.add_argument('-d', '--debug', help='provide debug information', action='store_true')

	args = parser.parse_args()
	conf = config.Config(HOME)
	done = False

	cmd.DRY = args.show
	cmd.VERBOSE = args.verbose
	vyos_build = conf['build']['repo']

	todo = {
		('vyos-1x', args.vyos),
		('vyos-smoketest', args.smoke),
		('vyatta-cfg-system', args.cfg),
		('vyatta-op', args.op)
	}

	if args.setup:
		repository.setup(conf)

	repository.update(conf, vyos_build)
	for package, option in todo:
		if option:
			done = repository.build(conf, vyos_build, LOCATION, package, option)

	if done or args.force:
		repository.configure(conf, vyos_build, LOCATION, conf['email'], args.extra, args.name)
		repository.backdoor(conf, vyos_build, args.backdoor)
		repository.make(conf, 'iso')

	if args.test:
		repository.make(conf, 'test')

	if not cmd.DRY:
		log.completed()
