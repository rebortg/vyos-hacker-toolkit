#!/bin/bash

if [ $# -eq 0 ]
then
	echo "Usage:"
	echo "$0 followed by the name of the repo to build (ie: T31)"
	exit
fi

# Get configuration

wd=$( pwd )
etc="$( cd "$(dirname "$0")"/../etc ; pwd ; cd - > /dev/null 2>/dev/null )"
data="$( cd "$(dirname "$0")"/../data ; pwd ; cd - > /dev/null 2>/dev/null )"
base=$( basename $1 )
cd $etc; for name in `ls`; do declare config_$name=$( cat $name ); done; cd - > /dev/null 2>/dev/null

local_folder=$( echo $config_local_folder | sed -e "s,\$HOME,$HOME," )

ssh_build_port=""
ssh_build_user=""
scp_build_port=""

ssh_router_port=""
ssh_router_user=""
scp_router_port=""

build_host=$config_build_host
router_host=$config_router_host
build_folder=$config_build_folder

if [ "$config_build_user" != "" ]; then
	ssh_build_user="$config_build_user@"
fi

if [ "$config_build_port" != "" ]; then
	ssh_build_port="-p $config_build_port"
	scp_build_port="-P $config_build_port"
fi

if [ "$config_router_user" != "" ]; then
	ssh_router_user="$config_router_user@"
	scp_router_port="-P $config_router_port"
fi

if [ "$config_router_port" != "" ]; then
	ssh_router_port="-p $config_router_port"
	scp_router_port="-P $config_router_port"
fi

connect_build="ssh $ssh_build_port $ssh_build_user$build_host"
connect_router="ssh $ssh_router_port $ssh_router_user$router_host"

# Check if remote router is up

echo "checking if the build machine is up"
up=$( $connect_build 'echo up' 2> /dev/null )
if [ "$up" != "up" ]; then
	echo "could not $connect_build"
	exit
fi

echo "checking if the router is up"
up=$( $connect_router 'echo up' 2> /dev/null )
if [ "$up" != "up" ]; then
	echo "could not $connect_router"
	exit
fi

echo $( date ) building

cd $local_folder/ 2> /dev/null

docker="docker run --rm --privileged -v $build_folder:$build_folder -w $build_folder/$1 vyos-builder"
command="dpkg-buildpackage -uc -us -tc -b"

$connect_build $docker /bin/sh -c $command

echo $( date ) deploying

cd $1 2> /dev/null
if [ "$?" != "0" ]; then
	echo "failed to locate vyos-1x folder at $local_folder/$1"
	exit
fi
cd .. 2> /dev/null

# copying
scp $scp_router_port vyos-1x_1.3.0-16_all.deb $ssh_router_user$router_host:

$connect_router "sudo dpkg -i --force-all vyos-1x_1.3.0-16_all.deb"
$connect_router "rm vyos-1x_1.3.0-16_all.deb"

# enable debugging
$connect_router "touch /tmp/vyos.ifconfig.debug"

echo $( date ) complete
