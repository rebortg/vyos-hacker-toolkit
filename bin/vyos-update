#!/bin/bash

if [ $# -eq 0 ]
then
	echo "Usage:"
	echo "$0 followed by the name of the repo to build (ie: T31)"
	exit
fi

# Get configuration

etc="$(cd "$(dirname "$0")"/../etc ; pwd)"
data="$(cd "$(dirname "$0")"/../data ; pwd)"
cd $etc; for name in `ls`; do declare config_$name=$( cat $name ); done; cd - > /dev/null

local_folder=$( echo $config_local_folder | sed -e "s,\$HOME,$HOME," )

ssh_router_user=""
ssh_router_port=""
scp_router_port=""

build_host=$config_build_host
router_host=$config_router_host

if [ "$config_router_user" != "" ]; then
	ssh_router_user=" $config_router_user@"
fi

if [ "$config_router_port" != "" ]; then
	ssh_router_port="-p $config_router_port"
	scp_router_port="-P $config_router_port"
fi

connect_router="ssh $router_port $ssh_router_user$router_host"

# Check if remote router is up

echo $connect_router 'echo up' 2> /dev/null
up=$( $connect_router 'echo up' 2> /dev/null )
if [ "$up" != "up" ]; then
	echo "could not ssh $router_port $ssh_router_user$build_host"
	exit
fi

echo $( date ) updating

cd $local_folder/$1 2> /dev/null

if [ "$?" != "0" ]; then
	echo "failed to locate vyos-1x folder at $local_folder/$1"
	exit
fi

scp $scp_router_port src/conf_mode/* $ssh_router_user@$router_host:/usr/libexec/vyos/conf_mode/
scp $scp_router_port python/vyos/*   $ssh_router_user@$router_host:/usr/lib/python3/dist-packages/vyos/

echo $( date ) complete
