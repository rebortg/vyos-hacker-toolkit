#!/bin/bash

if [ $# -eq 0 ]
then
	echo "Usage:"
	echo "$0 followed by the name of the repo to build (ie: T31)"
	exit
fi

# Get configuration

wd=$( pwd )
etc="$( cd "$(dirname "$0")"/../etc ; pwd ; cd - > /dev/null 2>/dev/null )"
data="$( cd "$(dirname "$0")"/../data ; pwd ; cd - > /dev/null 2>/dev/null )"
cd $etc; for name in `ls`; do declare config_$name=$( cat $name ); done; cd - > /dev/null 2>/dev/null

ssh_router_user=""
ssh_router_port=""
scp_router_port=""

build_host=$config_build_host
router_host=$config_router_host


echo $( date ) parsing command line
# ---------------------------------

option_vyos=""
option_vcfg=""

while [[ "$#" -gt 0 ]]; do case $1 in
	-v|--vyos) option_vyos="$2"; shift;;
	-c|--cfg) option_vcfg="$2"; shift;;
	*) echo "Unknown parameter passed: $1"; usage; exit 1;;
esac; shift; done

# check options

if [ "$option_vyos" == "" ]; then
	echo "missing vyos-1x repository"
	usage
	exit
fi

echo $( date ) building commands
# ------------------------------

if [ "$config_router_user" != "" ]; then
	ssh_router_user=" $config_router_user@"
fi

if [ "$config_router_port" != "" ]; then
	ssh_router_port="-p $config_router_port"
	scp_router_port="-P $config_router_port"
fi

connect_router="ssh $ssh_router_port $ssh_router_user$router_host"

echo $( date ) checking if the router is up
# -----------------------------------------

echo "checking if the router is up"
up=$( $connect_router 'echo up' 2> /dev/null )
if [ "$up" != "up" ]; then
	echo "could not $connect_router"
	exit
fi

if [ "$option_vyos" != "" ]; then
	echo $( date ) updating
	# ---------------------

	config_files=`find $option_vyos/src/conf_mode/ -name '*.py'`
	python_files=`find $option_vyos/python/vyos/   -name '*.py'`

	$connect_router sudo chown -R $config_router_user /usr/libexec/vyos/conf_mode
	$connect_router sudo chown -R $config_router_user /usr/lib/python3/dist-packages/vyos

	scp $scp_router_port $config_files $ssh_router_user$router_host:/usr/libexec/vyos/conf_mode
	scp $scp_router_port $python_files $ssh_router_user$router_host:/usr/lib/python3/dist-packages/vyos

	$connect_router sudo chown -R root /usr/libexec/vyos/conf_mode
	$connect_router sudo chown -R root /usr/lib/python3/dist-packages/vyos
fi

echo $( date ) complete
